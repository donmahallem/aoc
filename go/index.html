<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AOC 2024 Solver (WASM)</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
        line-height: 1.5;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: end;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 0.25rem;
      }
      input {
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
      }
      textarea {
        width: 100%;
        height: 200px;
        padding: 0.5rem;
        font-family: monospace;
        margin-bottom: 1rem;
        box-sizing: border-box;
      }
      button {
        padding: 0.75rem 1.5rem;
        background: #0070f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }
      button:hover {
        background: #0051a2;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #output {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        border: 1px solid #ddd;
        min-height: 50px;
      }
      .status {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>AOC Solver (Go/WASI)</h1>
    <div class="status" id="status">Loading WASM...</div>

    <div class="controls">
      <div>
        <label>Year</label><input type="number" id="year" value="2024" />
      </div>
      <div><label>Day</label><input type="number" id="day" value="1" /></div>
      <div><label>Part</label><input type="number" id="part" value="1" /></div>
      <div>
        <button id="runBtn" onclick="runSolver()" disabled>Run Solver</button>
      </div>
    </div>

    <label>Input Data</label>
    <textarea
      id="inputData"
      placeholder="Paste your puzzle input here..."
    ></textarea>

    <label>Result</label>
    <div id="output">Waiting for input...</div>

    <script>
      let wasmInstance = null;
      let wasmMemory = null;

      // Minimal WASI Shim for GOOS=wasip1
      // This provides the system calls expected by the Go runtime
      const wasiShim = {
        // Write to stdout/stderr
        fd_write: (fd, iovs_ptr, iovs_len, nwritten_ptr) => {
          const view = new DataView(wasmMemory.buffer);
          let written = 0;
          for (let i = 0; i < iovs_len; i++) {
            const ptr = view.getUint32(iovs_ptr + i * 8, true);
            const len = view.getUint32(iovs_ptr + i * 8 + 4, true);
            const chunk = new Uint8Array(wasmMemory.buffer, ptr, len);
            const msg = new TextDecoder().decode(chunk);

            if (fd === 1) console.log("[WASM stdout]", msg);
            else console.error("[WASM stderr]", msg);

            written += len;
          }
          view.setUint32(nwritten_ptr, written, true);
          return 0; // ESUCCESS
        },
        // Stubs for other required syscalls
        fd_close: () => 0,
        fd_fdstat_get: (fd, stat_ptr) => 0,
        fd_seek: () => 0,
        environ_sizes_get: (environc, environ_buf_size) => {
          const view = new DataView(wasmMemory.buffer);
          view.setUint32(environc, 0, true);
          view.setUint32(environ_buf_size, 0, true);
          return 0;
        },
        environ_get: (environ, environ_buf) => 0,
        proc_exit: (code) => console.log("WASM exited with code:", code),
        clock_time_get: () => 0,
      };

      async function loadWasm() {
        try {
          // Fetch the compiled WASM file
          const response = await fetch("./aoc.wasm");
          if (!response.ok)
            throw new Error(`Failed to fetch aoc.wasm: ${response.statusText}`);

          const { instance } = await WebAssembly.instantiateStreaming(
            response,
            {
              wasi_snapshot_preview1: wasiShim,
            }
          );

          wasmInstance = instance;
          wasmMemory = instance.exports.memory;

          // Initialize Go Runtime (runs the empty main() to setup GC etc.)
          if (instance.exports._start) {
            instance.exports._start();
          }

          document.getElementById("status").innerText = "WASM Loaded & Ready";
          document.getElementById("runBtn").disabled = false;
        } catch (e) {
          console.error(e);
          document.getElementById("status").innerText = "Error: " + e.message;
          document.getElementById("output").innerText =
            "Ensure you are running this via a local web server (e.g., python -m http.server) and aoc.wasm exists.";
        }
      }

      function runSolver() {
        if (!wasmInstance) return;

        const year = parseInt(document.getElementById("year").value);
        const day = parseInt(document.getElementById("day").value);
        const part = parseInt(document.getElementById("part").value);
        const inputStr = document.getElementById("inputData").value;

        const t0 = performance.now();

        // 1. Encode Input String to Bytes
        const encoder = new TextEncoder();
        const encodedInput = encoder.encode(inputStr);
        const inputLen = encodedInput.length;

        // 2. Allocate Memory in WASM
        // Go export: func malloc(size uint32) unsafe.Pointer
        const inputPtr = wasmInstance.exports.malloc(inputLen);

        // 3. Copy Input to WASM Memory
        const memView = new Uint8Array(wasmMemory.buffer);
        memView.set(encodedInput, inputPtr);

        // 4. Call the Solver
        // Go export: func solveAOC(year, day, part, ptr, len) uint64
        // Returns packed uint64: [32-bit ptr][32-bit len]
        const packedResult = wasmInstance.exports.solveAOC(
          year,
          day,
          part,
          inputPtr,
          inputLen
        );

        // 5. Unpack Result (BigInt operations required for 64-bit)
        const resultPtr = Number(packedResult >> 32n);
        const resultLen = Number(packedResult & 0xffffffffn);

        // 6. Read Result from WASM Memory
        if (resultLen === 0) {
          document.getElementById("output").innerText =
            "No result returned (or empty).";
        } else {
          const resultBytes = new Uint8Array(
            wasmMemory.buffer,
            resultPtr,
            resultLen
          );
          const resultStr = new TextDecoder().decode(resultBytes);

          const t1 = performance.now();
          document.getElementById("output").innerText =
            resultStr + `\n\n(JS Time: ${(t1 - t0).toFixed(2)}ms)`;
        }

        // Optional: Free the input memory (if your Go code implements free logic)
        // wasmInstance.exports.free(inputPtr, inputLen);
      }

      loadWasm();
    </script>
  </body>
</html>
